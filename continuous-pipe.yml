variables:
    - name: DEBUG_MODE
      condition: code_reference.branch == "master"
      value: false
    - name: DEBUG_MODE
      condition: code_reference.branch != "master"
      value: true

tasks:
    images:
        build:
            services:
                app:
                    image: docker.io/inviqasession/cp-website

    deploy:
        deploy:
            cluster: ${CLUSTER}
            services:
                app:          
                    specification:
                        environment_variables:
                            - name: DEBUG_MODE
                              value: ${DEBUG_MODE}
                            - name: CONTENTFUL_ACCESS_TOKEN
                              value: ${CONTENTFUL_ACCESS_TOKEN}
                            - name: CONTENTFUL_SPACE_ID
                              value: ${CONTENTFUL_SPACE_ID}
                            - name: CONTENTFUL_POST_CONTENT_TYPE
                              value: ${CONTENTFUL_POST_CONTENT_TYPE}
                            - name: CONTENTFUL_TAG_CONTENT_TYPE
                              value: ${CONTENTFUL_TAG_CONTENT_TYPE}
                              
                    endpoints:
                        -
                            name: https
                            type: NodePort
                            ssl_certificates:
                                -
                                    name: continuouspipeio
                                    cert: ${WILDCARD_SSL_CERT}
                                    key: ${WILDCARD_SSL_KEY}

                    deployment_strategy:
                        readiness_probe:
                            type: http
                            port: 80
                            path: /
